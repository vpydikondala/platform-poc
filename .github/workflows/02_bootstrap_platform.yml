name: 02 - Bootstrap Platform (Helm + Ingress + Backstage)

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  bootstrap:
    runs-on: ubuntu-latest
    env:
      POSTGRES_ADMIN_PASSWORD: ${{ secrets.POSTGRES_ADMIN_PASSWORD }}
      BACKSTAGE_GITHUB_TOKEN: ${{ secrets.BACKSTAGE_GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v4

      - name: Download infra outputs from workflow 01
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: 01_infra_apply.yml
          workflow_conclusion: success
          name: infra-outputs
          path: artifacts
          branch: main

      - name: Load infra outputs
        run: |
          set -a
          source artifacts/infra.outputs.env
          set +a
          echo "RG_NAME=$RG_NAME" >> $GITHUB_ENV
          echo "AKS_NAME=$AKS_NAME" >> $GITHUB_ENV
          echo "ACR_NAME=$ACR_NAME" >> $GITHUB_ENV
          echo "STORAGE_ACCOUNT=$STORAGE_ACCOUNT" >> $GITHUB_ENV
          echo "BACKSTAGE_MI_CLIENT_ID=$BACKSTAGE_MI_CLIENT_ID" >> $GITHUB_ENV
          echo "POSTGRES_FQDN=$POSTGRES_FQDN" >> $GITHUB_ENV
          echo "POSTGRES_DB=$POSTGRES_DB" >> $GITHUB_ENV
          echo "POSTGRES_ADMIN_USER=$POSTGRES_ADMIN_USER" >> $GITHUB_ENV

      - uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - uses: azure/setup-kubectl@v4
      - uses: azure/setup-helm@v4

      - name: Create poc.env
        run: cp poc.env.example poc.env

      - name: Render base templates
        run: bash scripts/render.sh templates rendered

      - name: Get AKS credentials
        run: |
          az aks get-credentials -g "$RG_NAME" -n "$AKS_NAME" --overwrite-existing
          kubectl get nodes

      - name: Install platform components
        run: bash scripts/bootstrap_platform.sh

      - name: Wait for ingress IP
        run: bash scripts/wait_for_ingress_ip.sh

      - name: Apply Argo CD + Backstage ingresses/certs
        run: bash scripts/apply_ingresses.sh
        env:
          INGRESS_IP: ${{ env.INGRESS_IP }}
      - name: Build & Push Backstage Image
        run: |
          echo "Logging in to ACR..."
          az acr login -n $ACR_NAME
          docker build -t $ACR_NAME.azurecr.io/backstage:latest -f packages/backend/Dockerfile .
          docker push $ACR_NAME.azurecr.io/backstage:latest
      - name: Render Backstage Helm values
        run: |
          set -a
          source poc.env
          source artifacts/infra.outputs.env
          set +a
          export INGRESS_IP="${{ env.INGRESS_IP }}"
          export POSTGRES_HOST="$POSTGRES_FQDN"
          export POSTGRES_USER="$POSTGRES_ADMIN_USER"
          export POSTGRES_PASSWORD="$POSTGRES_ADMIN_PASSWORD"
          export BACKSTAGE_MI_CLIENT_ID="$BACKSTAGE_MI_CLIENT_ID"
          export STORAGE_ACCOUNT="$STORAGE_ACCOUNT"
          export ACR_NAME="$ACR_NAME"
          export BACKSTAGE_GITHUB_TOKEN="$BACKSTAGE_GITHUB_TOKEN"
          mkdir -p rendered/backstage
          envsubst < templates/backstage/backstage-values.yaml.tpl > rendered/backstage/backstage-values.yaml

      - name: Deploy Backstage
        run: bash scripts/deploy_backstage.sh
        env:
          INGRESS_IP: ${{ env.INGRESS_IP }}

      - name: Print URLs
        run: |
          source poc.env
          echo "Argo CD: https://${ARGOCD_HOST_PREFIX}.${{ env.INGRESS_IP }}.sslip.io"
          echo "Backstage: https://${BACKSTAGE_HOST_PREFIX}.${{ env.INGRESS_IP }}.sslip.io"
